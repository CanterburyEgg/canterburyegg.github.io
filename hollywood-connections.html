<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hollywood Connections</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.png">
    <style>
        :root { 
            --sel: #5a5a5a; 
            --bg: #ffffff; 
            --card: #efefef; 
            --correct-bg: #d3d3d3; /* Soft Grey for solved */
            --toast-bg: #333;
        }

        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; margin: 0; padding-bottom: 40px;
            overflow-x: hidden;
        }

        header { 
            display: flex; align-items: center; justify-content: space-between; 
            width: 100%; max-width: 500px; padding: 15px; border-bottom: 1px solid #ddd; 
        }

        #calendar-btn { width: 30px; height: 30px; cursor: pointer; }

        .lives { margin: 20px 0; font-size: 16px; font-weight: 700; height: 24px; }

        .container { width: 95%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; }

        .solved-row {
            background: var(--correct-bg);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
            animation: slideIn 0.4s ease-out;
        }
        .solved-title { font-weight: 800; font-size: 18px; text-transform: uppercase; }
        .solved-actors { font-size: 13px; letter-spacing: 0.5px; }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .grid.shake { animation: shake 0.4s; }

        .card { 
            aspect-ratio: 1/1; background: var(--card); border-radius: 6px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; font-size: 10px; font-weight: 800; padding: 4px; border: 3px solid transparent; 
            overflow: hidden; text-transform: uppercase; user-select: none;
        }

        .card img { width: 100%; height: 75%; object-fit: cover; border-radius: 3px; margin-bottom: 4px; pointer-events: none; background: #ccc;}
        .card.selected { background: var(--sel); color: white; border-color: #333; }

        .controls { margin-top: 30px; display: flex; gap: 10px; }
        button { padding: 12px 20px; border-radius: 25px; border: 1px solid #000; background: white; cursor: pointer; font-weight: 600; }
        #submit-btn { background: #000; color: #fff; }

        #toast {
            position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
            background: var(--toast-bg); color: white; padding: 10px 20px;
            border-radius: 5px; font-weight: bold; opacity: 0; pointer-events: none;
            transition: opacity 0.3s, top 0.3s; z-index: 2000;
        }
        #toast.show { opacity: 1; top: 12%; }

        #archive-overlay { 
            display: none; position: absolute; top: 65px; width: 100%; max-width: 500px;
            background: white; z-index: 1500; padding: 20px; box-sizing: border-box;
            border-bottom: 2px solid #000;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<header>
    <img src="img/calendar.png" id="calendar-btn" onclick="toggleArchive()" alt="Archive">
    <h2 id="puzzle-title">Hollywood Connections</h2>
    <div style="width:30px"></div>
</header>

<div id="archive-overlay">
    <h3 style="margin-top:0">Archive</h3>
    <div id="archive-list" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px;"></div>
</div>

<div id="toast">One away...</div>
<div class="lives" id="lives-display">MISTAKES REMAINING: <span id="dots">••••</span></div>

<div class="container" id="game-container">
    <div id="solved-section" style="display:flex; flex-direction:column; gap:8px; margin-bottom:8px;"></div>
    <div id="board" class="grid"></div>
</div>

<div class="controls" id="game-controls">
    <button onclick="shuffleGrid()">Shuffle</button>
    <button onclick="deselect()">Deselect All</button>
    <button id="submit-btn" onclick="checkGuess()">Submit</button>
</div>

<script>
    const START_DATE = new Date("2026-01-01T00:00:00Z");
    const TMDB_BASE = "https://image.tmdb.org/t/p/w500";
    
    let allPuzzles = [];
    let currentPuzzle = [];
    let solvedCategories = [];
    let activeActors = [];
    let selection = [];
    let lives = 4;
    let isGameOver = false;

    async function init() {
        try {
            const res = await fetch('jsons/puzzle_batch.json');
            if (!res.ok) throw new Error("HTTP error " + res.status);
            allPuzzles = await res.json();
            loadByDay(new Date());
        } catch (e) { 
            console.error("Critical Failure:", e);
            document.body.innerHTML += `<p style='color:red; padding:20px;'>Error: Could not load data. Check Console.</p>`;
        }
    }

    function loadByDay(date) {
        const diff = Math.floor((date - START_DATE) / (1000 * 60 * 60 * 24));
        const idx = Math.abs(diff % allPuzzles.length);
        currentPuzzle = allPuzzles[idx];
        
        document.getElementById('puzzle-title').innerText = `Hollywood Connections #${diff + 1}`;
        document.getElementById('archive-overlay').style.display = 'none';
        document.getElementById('game-controls').style.display = 'flex';
        document.getElementById('lives-display').style.visibility = 'visible';
        
        lives = 4;
        isGameOver = false;
        solvedCategories = [];
        activeActors = currentPuzzle.flatMap(cat => cat.actors);
        shuffleArray(activeActors);
        
        updateLives();
        renderGame();

        const today = new Date();
        const realDiff = Math.floor((today - START_DATE) / (1000 * 60 * 60 * 24));
        renderArchiveList(realDiff);
    }

    function renderGame() {
        const board = document.getElementById('board');
        const solvedSection = document.getElementById('solved-section');
        board.innerHTML = '';
        solvedSection.innerHTML = '';
        selection = [];

        solvedCategories.forEach(cat => {
            const row = document.createElement('div');
            row.className = 'solved-row';
            row.innerHTML = `<div class="solved-title">${cat.title}</div><div class="solved-actors">${cat.actors.map(a=>a.name).join(', ')}</div>`;
            solvedSection.appendChild(row);
        });

        const solvedNames = solvedCategories.flatMap(c => c.actors.map(a => a.name));
        const remaining = activeActors.filter(a => !solvedNames.includes(a.name));
        
        remaining.forEach(a => {
            const card = document.createElement('div');
            card.className = 'card';
            const imgPath = a.profile_path ? TMDB_BASE + a.profile_path : '';
            const imgHTML = imgPath ? `<img src="${imgPath}">` : `<div style="height:75%; background:#eee"></div>`;
            
            card.innerHTML = `${imgHTML}<p>${a.name}</p>`;
            card.onclick = () => {
                if (isGameOver) return;
                if (card.classList.contains('selected')) {
                    card.classList.remove('selected');
                    selection = selection.filter(n => n !== a.name);
                } else if (selection.length < 4) {
                    card.classList.add('selected');
                    selection.push(a.name);
                }
            };
            board.appendChild(card);
        });
    }

    function checkGuess() {
        if (selection.length !== 4 || isGameOver) return;

        const found = currentPuzzle.find(cat => 
            cat.actors.every(actorObj => selection.includes(actorObj.name))
        );

        if (found) {
            solvedCategories.push(found);
            renderGame();
            if (solvedCategories.length === 4) showToast("Puzzle Complete!");
        } else {
            currentPuzzle.forEach(cat => {
                const matchCount = cat.actors.filter(a => selection.includes(a.name)).length;
                if (matchCount === 3) showToast("One away...");
            });

            lives--;
            updateLives();
            const board = document.getElementById('board');
            board.classList.add('shake');
            setTimeout(() => board.classList.remove('shake'), 400);
            
            if (lives <= 0) endGame();
        }
    }

    async function endGame() {
        isGameOver = true;
        showToast("Game Over");
        document.getElementById('game-controls').style.display = 'none';
        document.getElementById('lives-display').style.visibility = 'hidden';
        
        // Find categories not yet solved
        const solvedTitles = solvedCategories.map(c => c.title);
        const remainingCats = currentPuzzle.filter(cat => !solvedTitles.includes(cat.title));

        // Reveal remaining categories with a delay
        for (const cat of remainingCats) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            solvedCategories.push(cat);
            renderGame();
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    function updateLives() {
        document.getElementById('dots').innerText = "•".repeat(Math.max(0, lives));
    }

    function shuffleGrid() {
        const solvedNames = solvedCategories.flatMap(c => c.actors.map(a => a.name));
        let remaining = activeActors.filter(a => !solvedNames.includes(a.name));
        shuffleArray(remaining);
        activeActors = [...solvedCategories.flatMap(c => c.actors), ...remaining];
        renderGame();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function deselect() {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        selection = [];
    }

    function toggleArchive() {
        const over = document.getElementById('archive-overlay');
        over.style.display = over.style.display === 'block' ? 'none' : 'block';
    }

    function renderArchiveList(max) {
        const list = document.getElementById('archive-list');
        list.innerHTML = '';
        for (let i = 0; i <= max; i++) {
            const d = document.createElement('div');
            d.style.cssText = "padding:10px; background:#eee; text-align:center; cursor:pointer; border-radius:4px; font-weight:bold;";
            d.innerText = i + 1;
            d.onclick = () => {
                let t = new Date(START_DATE);
                t.setDate(t.getDate() + i);
                loadByDay(t);
            };
            list.appendChild(d);
        }
    }

    init();
</script>
</body>
</html>