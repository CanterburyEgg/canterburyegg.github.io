<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RPG MVP</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #game-container { max-width: 950px; width: 100%; background: #1e1e1e; padding: 25px; border: 2px solid #d4af37; box-shadow: 0 0 20px #000; }
        .screen { display: none; }
        .active { display: block; }
        h1, h2 { color: #d4af37; text-align: center; text-transform: uppercase; letter-spacing: 2px; margin-top: 0; }
        #boss-intel { background: #300; border: 1px solid red; padding: 10px; margin-bottom: 15px; font-size: 0.85em; color: #ff9999; text-align: center; border-radius: 4px; }
        .roll-display { font-size: 4em; text-align: center; margin: 10px 0; color: #fff; text-shadow: 0 0 10px gold; font-weight: bold; }
        .stat-btn { background: #333; color: #fff; border: 1px solid #d4af37; padding: 12px; width: 100%; cursor: pointer; margin-bottom: 5px; font-family: inherit; }
        .stat-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; }
        .discard-btn { background: #600; color: white; border: none; padding: 12px; width: 100%; margin-top: 10px; cursor: pointer; font-family: inherit; font-weight: bold; }
        .assignment-container { display: flex; justify-content: space-around; gap: 20px; margin-top: 20px; }
        .p-box { background: #252525; padding: 15px; border-radius: 4px; width: 45%; border: 1px solid #444; }
        .class-option-card { background: #333; border: 1px solid gold; padding: 10px; margin-top: 10px; border-radius: 4px; text-align: left; }
        .class-option-card small { color: #aaa; display: block; margin-bottom: 8px; font-size: 0.8em; line-height: 1.3; }
        #combat-log { height: 180px; background: #000; overflow-y: scroll; padding: 10px; margin: 20px 0; border-left: 4px solid #d4af37; color: #0f0; font-size: 0.9em; }
        .hp-bar-outer { height: 12px; background: #444; width: 100%; margin: 8px 0; border-radius: 2px; }
        .hp-bar-inner { height: 100%; background: #c0392b; transition: width 0.3s; border-radius: 2px; }
        .controls { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .controls button { background: #d4af37; border: none; padding: 10px; font-weight: bold; cursor: pointer; font-family: inherit; border-radius: 3px; }
        .controls button:disabled { background: #444; color: #777; cursor: not-allowed; border: 1px solid #222; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="setup-screen" class="active">
        <h1>Hero Creation</h1>
        <div class="roll-display" id="current-roll">??</div>
        <div class="assignment-container">
            <div class="p-box" id="p0-ui">
                <h3>Hero 1</h3>
                <button class="stat-btn" onclick="assignTo(0, 'STR')">STR: <span id="p0-STR">-</span></button>
                <button class="stat-btn" onclick="assignTo(0, 'DEX')">DEX: <span id="p0-DEX">-</span></button>
                <button class="stat-btn" onclick="assignTo(0, 'CON')">CON: <span id="p0-CON">-</span></button>
                <button class="stat-btn" onclick="assignTo(0, 'ARC')">ARC: <span id="p0-ARC">-</span></button>
                <div id="p0-classes"></div>
            </div>
            <div class="p-box" id="p1-ui">
                <h3>Hero 2</h3>
                <button class="stat-btn" onclick="assignTo(1, 'STR')">STR: <span id="p1-STR">-</span></button>
                <button class="stat-btn" onclick="assignTo(1, 'DEX')">DEX: <span id="p1-DEX">-</span></button>
                <button class="stat-btn" onclick="assignTo(1, 'CON')">CON: <span id="p1-CON">-</span></button>
                <button class="stat-btn" onclick="assignTo(1, 'ARC')">ARC: <span id="p1-ARC">-</span></button>
                <div id="p1-classes"></div>
            </div>
        </div>
        <button id="discard-btn" class="discard-btn" onclick="discardRoll()">DISCARD ROLL (1 REMAINING)</button>
        <button id="start-btn" style="background:green; color:white; padding:20px; margin-top:20px; display:none; border:none; width:100%; cursor:pointer;" onclick="startCombat()">ENTER DUNGEON</button>
    </div>

    <div id="combat-screen" class="screen">
        <div id="boss-intel">BOSS INTEL: ...</div>
        <h2 id="boss-name">BOSS</h2>
        <div id="boss-indicators" style="text-align:center; font-size:0.8em; color:red; margin-bottom:5px; height:1.2em;"></div>
        <div class="hp-bar-outer"><div id="boss-hp-fill" class="hp-bar-inner"></div></div>
        <div id="combat-log"></div>
        <div style="display:flex; justify-content:space-between; gap:20px;">
            <div id="card-0" class="p-box" style="width:100%"></div>
            <div id="card-1" class="p-box" style="width:100%"></div>
        </div>
        <button id="end-turn-btn" onclick="endTurn()" style="margin-top:20px; padding:15px; width:100%; background:gold; font-weight:bold; cursor:pointer; border:none;">END PLAYER TURN</button>
    </div>
</div>

<script>
const CLASS_DESC = {
    "Berserker": "Axe (STR/3 - 1). Hits add WOUNDS (+1 dmg per wound stack).",
    "Slayer": "Sword (STR/3 + 2). Pure Dmg focus.",
    "Bulwark": "Mace (STR/3). Passive: -2 dmg taken.",
    "Warden": "Halberd (STR/3). Boss forces Warden as target.",
    "Assassin": "Daggers (STR/6 x 2). Hits twice for 1 AP.",
    "Ranger": "Longbow (STR/3). Aim (2AP): x2 Dmg next hit.",
    "Sorcerer": "Bolt (ARC/3). Great Bolt (3AP): 10 Dmg.",
    "Scholar": "Strike (STR/3). Heal (1AP): ARC/3 self.",
    "Gladiator": "Spear (STR/3). Momentum: +1 dmg when hit.",
    "Vanguard": "Greatsword (STR/3). Power Stance (2AP): +2 dmg (Once).",
    "Dragoon": "Lance (STR/3). Counter 2 back when hit.",
    "Monk": "Fists (STR/3). Focus (3AP): 10 Dmg hit.",
    "Duelist": "Rapier (STR/3). 1-in-6 chance to deal DEX dmg.",
    "Samurai": "Katana (STR/3). Bleed: 6th hit deals +DEX dmg.",
    "Paladin": "Mace (STR/3). Bless (2AP): +2 dmg/Lifesteal.",
    "Cleric": "Brand (2AP): Ally +1 dmg. Flash Heal (2AP): Heal party 2.",
    "Spellblade": "Magic Dart (ARC/4). Echoing Blade (3AP): Spells x 3.",
    "Inquisitor": "Crossbow (STR/3). Silver Bolt (2AP): Deal ARC dmg.",
    "Blood Knight": "Flail (STR/3). Infuse (2AP): +2 Dmg / -2 HP self.",
    "Warlock": "Scythe (2AP): STR/3 + 3. Soul Harvest: Heal if Ally low."
};

const BOSSES = [
    { name: "The Grunt", hp: 15, max: 15, intel: "1-3: 3 Dmg Both | 4-6: 5 Dmg One", logic: (r) => r <= 3 ? {d:3, t:'both'} : {d:5, t:'one'} },
    { name: "The Bulwark", hp: 25, max: 25, intel: "1-5: 5 Dmg High HP | 6: 10 Dmg Rand", logic: (r) => r <= 5 ? {d:5, t:'most'} : {d:10, t:'rand'} },
    { name: "The Hunter", hp: 35, max: 35, intel: "1-2: 4 Both | 3-4: 8 Rand | 5-6: 8 Low HP", logic: (r) => r <= 2 ? {d:4, t:'both'} : r <= 4 ? {d:8, t:'rand'} : {d:8, t:'low'} },
    { name: "The Twin-Soul", hp: 50, max: 50, intel: "1-3: 3 Both, -1 AP | 4-5: 6 Rand, Heals | 6: 6 Rand, -2 AP", logic: (r) => r <= 3 ? {d:3, t:'both', ap:-1} : r <= 5 ? {d:6, t:'rand', h:true} : {d:6, t:'rand', ap:-2} }
];

const CLASS_MATRIX = {
    "STR": ["Berserker", "Slayer"], "CON": ["Bulwark", "Warden"], "DEX": ["Assassin", "Ranger"], "ARC": ["Sorcerer", "Scholar"],
    "CON,STR": ["Gladiator", "Vanguard"], "CON,DEX": ["Dragoon", "Monk"], "DEX,STR": ["Samurai", "Duelist"],
    "ARC,STR": ["Paladin", "Cleric"], "ARC,DEX": ["Spellblade", "Inquisitor"], "ARC,CON": ["Blood Knight", "Warlock"]
};

let players = [{stats:{STR:0,DEX:0,CON:0,ARC:0},class:null,hp:0,maxHp:0,ap:0,baseAp:0,armor:0,spells:0,momentum:0,power:0,powerUsed:false,aim:false,blessed:false,infused:false,bleed:0}, {stats:{STR:0,DEX:0,CON:0,ARC:0},class:null,hp:0,maxHp:0,ap:0,baseAp:0,armor:0,spells:0,momentum:0,power:0,powerUsed:false,aim:false,blessed:false,infused:false,bleed:0}];
let discardRemaining = 1, statsAssigned = 0, bossIdx = 0, wounds = 0, branded = false;

function roll() {
    let r = (Math.floor(Math.random() * 6) + 1) + (Math.floor(Math.random() * 6) + 1);
    document.getElementById('current-roll').innerText = r;
}

function assignTo(pIdx, stat) {
    players[pIdx].stats[stat] = parseInt(document.getElementById('current-roll').innerText);
    document.getElementById(`p${pIdx}-${stat}`).innerText = players[pIdx].stats[stat];
    statsAssigned++;
    if (statsAssigned >= 8) finalizeSetup(); else roll();
}

function discardRoll() { discardRemaining--; document.getElementById('discard-btn').style.display = 'none'; roll(); }

function finalizeSetup() {
    document.querySelectorAll('.stat-btn').forEach(b => b.disabled = true);
    players.forEach((p, i) => {
        let s = Object.entries(p.stats).sort((a,b) => b[1] - a[1]);
        let key = s[0][1] - s[1][1] <= 1 ? [s[0][0], s[1][0]].sort().join(',') : s[0][0];
        const options = CLASS_MATRIX[key] || ["Slayer", "Berserker"];
        const div = document.getElementById(`p${i}-classes`);
        options.forEach(cls => {
            const card = document.createElement('div'); card.className = 'class-option-card';
            card.innerHTML = `<strong>${cls}</strong><br><small>${CLASS_DESC[cls]}</small>`;
            const b = document.createElement('button'); b.innerText = "Select " + cls; b.style.width="100%";
            b.onclick = () => { p.class = cls; div.innerHTML = `<h3>${cls}</h3>`; checkReady(); };
            card.appendChild(b); div.appendChild(card);
        });
    });
}

function checkReady() { if(players[0].class && players[1].class) document.getElementById('start-btn').style.display='block'; }

function startCombat() {
    players.forEach(p => {
        p.maxHp = 20 + (p.stats.CON * 2); p.hp = p.maxHp;
        p.baseAp = 1 + Math.floor(p.stats.STR / 3); p.ap = p.baseAp;
    });
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('combat-screen').classList.add('active');
    update();
}

function update() {
    const b = BOSSES[bossIdx];
    document.getElementById('boss-intel').innerText = `INTEL: ${b.intel}`;
    document.getElementById('boss-name').innerText = `${b.name} (${b.hp}/${b.max})`;
    document.getElementById('boss-hp-fill').style.width = (b.hp/b.max*100) + "%";
    document.getElementById('boss-indicators').innerText = (wounds > 0 ? `[WOUNDS: ${wounds}] ` : "") + (branded ? "[BRANDED]" : "");
    players.forEach((p, i) => {
        const card = document.getElementById(`card-${i}`);
        card.innerHTML = `<strong>${p.class}</strong><br>HP: ${p.hp}/${p.maxHp} | AP: ${p.ap}
            <div class="hp-bar-outer"><div class="hp-bar-inner" style="width:${(p.hp/p.maxHp*100)}%"></div></div>
            <div class="controls">${generateButtons(p, i)}</div>`;
    });
}

function generateButtons(p, i) {
    let b = `<button onclick="handleAction(${i}, 'atk')" ${p.ap < 1 ? 'disabled':''}>Attack (1 AP)</button>`;
    if (p.class === 'Sorcerer') b = `<button onclick="handleAction(${i}, 'bolt')" ${p.ap < 1 ? 'disabled':''}>Bolt (1 AP)</button><button onclick="handleAction(${i}, 'great')" ${p.ap < 3 ? 'disabled':''}>Great Bolt (3 AP)</button>`;
    if (p.class === 'Scholar') b += `<button onclick="handleAction(${i}, 'heal')" ${p.ap < 1 ? 'disabled':''}>Heal (1 AP)</button>`;
    if (p.class === 'Ranger') b += `<button onclick="handleAction(${i}, 'aim')" ${p.ap < 2 ? 'disabled':''}>Aim (2 AP)</button>`;
    if (p.class === 'Vanguard') b += `<button onclick="handleAction(${i}, 'power')" ${(p.ap < 2 || p.powerUsed) ? 'disabled':''}>Stance (2 AP)</button>`;
    if (p.class === 'Spellblade') b = `<button onclick="handleAction(${i}, 'dart')" ${p.ap < 1 ? 'disabled':''}>Dart (1 AP)</button><button onclick="handleAction(${i}, 'echo')" ${p.ap < 3 ? 'disabled':''}>Echo (3 AP)</button>`;
    if (p.class === 'Blood Knight') b = `<button onclick="handleAction(${i}, 'infuse')" ${p.ap < 2 ? 'disabled':''}>${p.infused ? 'Uninfuse' : 'Infuse'} (2 AP)</button>` + b;
    if (p.class === 'Paladin') b += `<button onclick="handleAction(${i}, 'bless')" ${p.ap < 2 ? 'disabled':''}>Bless (2 AP)</button>`;
    if (p.class === 'Cleric') b = `<button onclick="handleAction(${i}, 'brand')" ${p.ap < 2 ? 'disabled':''}>Brand (2 AP)</button><button onclick="handleAction(${i}, 'flash')" ${p.ap < 2 ? 'disabled':''}>Flash Heal (2 AP)</button>` + b;
    if (p.class === 'Monk') b += `<button onclick="handleAction(${i}, 'focus')" ${p.ap < 3 ? 'disabled':''}>Focus (3 AP)</button>`;
    if (p.class === 'Inquisitor') b += `<button onclick="handleAction(${i}, 'silver')" ${p.ap < 2 ? 'disabled':''}>Silver Bolt (2 AP)</button>`;
    return b + `<button onclick="handleAction(${i}, 'shd')" ${p.ap < 1 ? 'disabled':''}>Shield (1 AP)</button>`;
}

function handleAction(i, type) {
    const p = players[i], b = BOSSES[bossIdx];
    let dmg = 0, cost = 1, heal = 0;
    let base = 1 + Math.floor(p.stats.STR / 3);
    let arc = 1 + Math.floor(p.stats.ARC / 3);

    if (['power', 'infuse', 'aim', 'brand', 'flash', 'bless', 'silver'].includes(type)) cost = 2;
    if (['echo', 'great', 'focus'].includes(type)) cost = 3;
    if (p.ap < cost) return;

    if (type === 'atk') {
        if (p.class === 'Slayer') dmg = base + 2;
        else if (p.class === 'Berserker') { dmg = base - 1; wounds++; }
        else if (p.class === 'Assassin') { dmg = Math.floor(p.stats.STR / 6) * 2; log("Double Strike!"); }
        else if (p.class === 'Vanguard') dmg = base + p.power;
        else if (p.class === 'Samurai') { dmg = base; p.bleed++; if(p.bleed >= 6){ dmg += p.stats.DEX; p.bleed=0; log("Samurai Bleed Proc!"); } }
        else if (p.class === 'Duelist') { dmg = (Math.random() < 0.16) ? p.stats.DEX : base; if(dmg > base) log("Duelist DEX Crit!"); }
        else if (p.class === 'Blood Knight') { dmg = base + (p.infused ? 2 : 0); if(p.infused) p.hp -= 2; }
        else if (p.class === 'Gladiator') dmg = base + p.momentum;
        else dmg = base;
        if (p.blessed) { dmg += 2; heal = 2; }
    }
    if (type === 'bolt') dmg = arc;
    if (type === 'great' || type === 'focus') dmg = 10;
    if (type === 'dart') { dmg = Math.floor(p.stats.ARC / 4); p.spells++; }
    if (type === 'echo') { dmg = p.spells * 3; p.spells = 0; }
    if (type === 'heal') heal = arc;
    if (type === 'aim') p.aim = true;
    if (type === 'power') { p.power = 2; p.powerUsed = true; }
    if (type === 'silver') dmg = arc;
    if (type === 'brand') branded = true;
    if (type === 'flash') players.forEach(pl => pl.hp = Math.min(pl.maxHp, pl.hp + 2));
    if (type === 'bless') p.blessed = true;
    if (type === 'infuse') p.infused = !p.infused;
    if (type === 'shd') p.armor += 2;

    p.ap -= cost;
    if (p.aim && dmg > 0) { dmg *= 2; p.aim = false; }
    if (dmg > 0) { let f = dmg + wounds + (branded ? 1 : 0); b.hp -= f; log(`${p.class} deals ${f} dmg.`); }
    if (heal > 0) p.hp = Math.min(p.maxHp, p.hp + heal);
    checkStates(); update();
}

function endTurn() {
    const b = BOSSES[bossIdx];
    let r = Math.floor(Math.random() * 6) + 1;
    let act = b.logic(r);
    log(`[BOSS] ${b.name} rolls ${r}`);
    
    let targetIdx = -1;
    if (act.t === 'most') targetIdx = players[0].hp >= players[1].hp ? 0 : 1;
    if (act.t === 'low') targetIdx = players[0].hp <= players[1].hp ? 0 : 1;
    if (act.t === 'rand') targetIdx = Math.floor(Math.random() * 2);

    players.forEach((p, i) => {
        let hit = 0;
        if (act.t === 'both') hit = act.d;
        else if (i === targetIdx) hit = act.d;

        // Warden Taunt Override
        let realTarget = (players[0].class === 'Warden' || players[1].class === 'Warden') && act.t !== 'both';
        if (realTarget && p.class !== 'Warden') hit = 0;
        if (realTarget && p.class === 'Warden') hit = act.d;

        let final = Math.max(0, hit - (p.class === 'Bulwark' ? 2 : 0) - p.armor);
        p.hp -= final;
        if (act.h && final > 0) b.hp = Math.min(b.max, b.hp + final);
        if (final > 0) {
            log(`${p.class} takes ${final} dmg.`);
            if (p.class === 'Gladiator') p.momentum++;
            if (p.class === 'Dragoon') { b.hp -= 2; log("Dragoon Counter!"); }
        }
        p.ap = Math.max(0, p.baseAp + (act.ap || 0)); p.armor = 0; p.blessed = false;
    });
    branded = false; checkStates(); update();
}

function checkStates() {
    if (players.some(p => p.hp <= 0)) { alert("GAME OVER"); location.reload(); }
    if (BOSSES[bossIdx].hp <= 0) victory();
}

function victory() {
    log(`VICTORY! ${BOSSES[bossIdx].name} defeated.`);
    bossIdx++;
    if (bossIdx >= BOSSES.length) { alert("YOU CONQUERED THE DUNGEON!"); location.reload(); }
    else {
        players.forEach(p => { 
            p.hp = Math.min(p.maxHp, p.hp + 5); 
            p.ap = p.baseAp; p.power = 0; p.powerUsed = false; p.momentum = 0; p.spells = 0; 
            p.infused = false; p.bleed = 0; p.aim = false;
        });
        wounds = 0; log(`Healed 5 HP. Statuses Cleared. Moving to Floor ${bossIdx + 1}...`); update();
    }
}

function log(m) { 
    const c = document.getElementById('combat-log');
    c.innerHTML += `> ${m}<br>`; c.scrollTop = c.scrollHeight;
}
roll();
</script>
</body>
</html>