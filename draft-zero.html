<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draft Zero</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.png">
    <style>
        :root {
            --bg-color: #f4f4f4;
            --paper-color: #ffffff;
            --text-color: #2d2d2d;
            --hidden-color: #2a2a2a; 
            --red-alert: #b33939;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            background: #e8e8e8;
            padding: 15px 0;
            position: fixed;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .header-top {
            width: 90%;
            max-width: 1100px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 95%;
            max-width: 1100px;
            position: relative;
        }

        #calendar-btn { cursor: pointer; width: 32px; height: 32px; }

        .input-wrapper { flex: 1; position: relative; }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            box-sizing: border-box;
        }

        #autocomplete-results {
            position: absolute;
            top: 42px;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        .autocomplete-item:hover { background: #f0f0f0; }

        button {
            padding: 10px 15px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border: 1px solid #aaa;
            background: #fff;
            white-space: nowrap;
        }

        button:hover { background: #f0f0f0; }
        .btn-giveup { color: var(--red-alert); font-size: 11px; border-color: #fcc; }
        #hint-btn { background: #fffbe6; border-color: #ffe58f; }

        #score-display { font-weight: bold; font-size: 1.3rem; min-width: 150px; text-align: right; }

        #victory-title {
            display: none;
            text-align: center;
            font-size: 2rem;
            color: var(--red-alert);
            margin-bottom: 50px;
            border: 3px solid var(--red-alert);
            padding: 10px;
            transform: rotate(-2deg);
            width: fit-content;
            align-self: center;
        }

        #main-content {
            margin-top: 180px;
            margin-bottom: 50px;
            width: 90%;
            max-width: 850px;
            background: var(--paper-color);
            padding: 60px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            min-height: 100vh;
            line-height: 1.7;
            font-size: 1.15rem;
            white-space: pre-wrap;
            display: flex;
            flex-direction: column;
        }

        .hidden { background-color: var(--hidden-color); color: var(--hidden-color); border-radius: 1px; user-select: none; }
        .revealed { background-color: transparent; color: inherit; }

        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: white; margin: 5% auto; padding: 40px 20px; width: 80%; max-width: 600px; border-radius: 8px; position: relative; }
        #close-archive { position: absolute; top: 10px; left: 10px; cursor: pointer; background: none; border: none; font-size: 24px; color: #888; }
        #game-list-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 500px; overflow-y: auto; padding: 10px; }
        .game-link { padding: 15px; background: #f8f8f8; border: 1px solid #eee; text-align: center; text-decoration: none; color: #333; border-radius: 4px; }
        
        #toast {
            visibility: hidden;
            min-width: 300px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 0 0 8px 8px;
            padding: 16px;
            position: fixed;
            z-index: 300;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #toast.show {
            visibility: visible;
            animation: slideDown 0.4s forwards, slideUp 0.4s 2.6s forwards;
        }

        @keyframes slideDown { from { top: -100px; } to { top: 0; } }
        @keyframes slideUp { from { top: 0; } to { top: -100px; } }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <img src="img/calendar.png" id="calendar-btn" onclick="openModal()" alt="Archive">
            <h1 id="game-title">Draft Zero #--</h1>
            <div id="score-display">Score: 100.0</div>
        </div>
        
        <div class="controls">
            <div class="input-wrapper">
                <input type="text" id="word-input" placeholder="Enter word..." autocomplete="off">
            </div>
            <button onclick="submitWord()">SUBMIT WORD</button>
            <button id="hint-btn" onclick="getHint()">HINT</button>
            <div class="input-wrapper">
                <input type="text" id="guess-input" placeholder="Guess Title..." autocomplete="off">
                <div id="autocomplete-results"></div>
            </div>
            <button onclick="submitGuess()">GUESS TITLE</button>
            <button class="btn-giveup" onclick="giveUp()">GIVE UP</button>
        </div>
    </header>

    <div id="main-content">
        <div id="victory-title"></div>
        <div id="script-display">Loading...</div>
    </div>

    <div id="toast"></div>

    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <button id="close-archive" onclick="closeModal()">âœ•</button>
            <h3 style="text-align: center;">Script Archive</h3>
            <div id="game-list-container"></div>
        </div>
    </div>

    <script>
        let gameState = {
            scripts: [],
            commonWords: new Set(),
            titles: [],
            currentScript: null,
            gameNumber: 0,
            revealedWords: new Set(),
            wrongGuesses: new Set(),
            score: 100.0,
            isGameOver: false,
            toastTimer: null
        };

        const EPOCH = new Date('2026-01-01');

        async function init() {
            try {
                const [scriptsRes, commonRes, csvRes] = await Promise.all([
                    fetch('jsons/redacted_scripts.json'),
                    fetch('lists/common_words.txt'),
                    fetch('lists/redactle_source_list.csv')
                ]);
                gameState.scripts = await scriptsRes.json();
                const commonText = await commonRes.text();
                commonText.split(/\r?\n/).forEach(w => { if(w.trim()) gameState.commonWords.add(w.trim().toLowerCase()); });
                const csvText = await csvRes.text();
                gameState.titles = parseCSV(csvText);
                calculateCurrentGame();
                loadGame();
                setupEventListeners();
            } catch (e) {
                console.error(e);
                document.getElementById('script-display').innerText = "Load Failure.";
            }
        }

        // Fuzzy Logic: Stemming
        function getStem(word) {
            word = word.toLowerCase();
            if (word.endsWith('ies') && word.length > 5) return word.slice(0, -3) + 'y';
            if (word.endsWith('ing') && word.length > 5) return word.slice(0, -3);
            if (word.endsWith('ed') && word.length > 4) return word.slice(0, -2);
            if (word.endsWith('es') && word.length > 4) return word.slice(0, -2);
            if (word.endsWith('s') && word.length > 3 && !word.endsWith('ss')) return word.slice(0, -1);
            return word;
        }

        function showToast(message) {
            const x = document.getElementById("toast");
            if (gameState.toastTimer) {
                clearTimeout(gameState.toastTimer);
                x.classList.remove("show");
                void x.offsetWidth; // Trigger reflow to restart animation
            }
            x.innerText = message;
            x.classList.add("show");
            gameState.toastTimer = setTimeout(() => { x.classList.remove("show"); }, 3000);
        }

        function setupEventListeners() {
            const wordIn = document.getElementById('word-input');
            const guessIn = document.getElementById('guess-input');
            const resultsDiv = document.getElementById('autocomplete-results');

            wordIn.addEventListener('keypress', (e) => { if (e.key === 'Enter') submitWord(); });
            guessIn.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                resultsDiv.innerHTML = '';
                if (val.length < 2) { resultsDiv.style.display = 'none'; return; }
                const matches = gameState.titles.filter(t => t.toLowerCase().includes(val)).slice(0, 10);
                if (matches.length > 0) {
                    matches.forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-item';
                        div.innerText = m;
                        div.onclick = () => { guessIn.value = m; resultsDiv.style.display = 'none'; };
                        resultsDiv.appendChild(div);
                    });
                    resultsDiv.style.display = 'block';
                } else { resultsDiv.style.display = 'none'; }
            });
            guessIn.addEventListener('keypress', (e) => { if (e.key === 'Enter') { resultsDiv.style.display = 'none'; submitGuess(); } });
            document.addEventListener('click', (e) => { if (e.target !== guessIn) resultsDiv.style.display = 'none'; });
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const titles = [];
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;
                let title = line.startsWith('"') ? line.substring(1, line.indexOf('",')) : line.split(',')[0];
                if (title) titles.push(title.replace(/^"|"$/g, '').trim());
            }
            return [...new Set(titles)].sort();
        }

        function calculateCurrentGame() {
            const now = new Date();
            const diffDays = Math.floor(Math.abs(now - EPOCH) / (1000 * 60 * 60 * 24));
            const urlParams = new URLSearchParams(window.location.search);
            const gParam = urlParams.get('g');
            gameState.gameNumber = gParam ? parseInt(gParam) : diffDays + 1;
            document.getElementById('game-title').innerText = `Draft Zero #${gameState.gameNumber}`;
        }

        function loadGame() {
            const index = (gameState.gameNumber * 13) % gameState.scripts.length;
            gameState.currentScript = gameState.scripts[index];
            renderScript();
        }

        function renderScript() {
            const container = document.getElementById('script-display');
            const words = gameState.currentScript.snippet.split(/(\s+)/);
            container.innerHTML = '';
            
            if (gameState.isGameOver) {
                const vTitle = document.getElementById('victory-title');
                vTitle.innerText = gameState.currentScript.title.toUpperCase();
                vTitle.style.display = 'block';
            }

            words.forEach(word => {
                if (/\s+/.test(word)) {
                    container.appendChild(document.createTextNode(word));
                } else {
                    const clean = word.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
                    const stem = getStem(clean);
                    const isJustPunctuation = !/[a-z0-9]/i.test(word);

                    const span = document.createElement('span');
                    span.innerText = word;

                    // Reveal if matches direct word OR if stems match (fuzzy)
                    const isRevealed = isJustPunctuation || 
                                     gameState.commonWords.has(clean) || 
                                     gameState.revealedWords.has(clean) || 
                                     gameState.revealedWords.has(stem) ||
                                     gameState.isGameOver;

                    span.className = isRevealed ? 'revealed' : 'hidden';
                    container.appendChild(span);
                }
            });
        }

        function updateScore(points) {
            if (gameState.isGameOver) return;
            gameState.score += points;
            if (gameState.score < 1) gameState.score = 1;
            document.getElementById('score-display').innerText = `Score: ${gameState.score.toFixed(1)}`;
        }

        function submitWord() {
            if (gameState.isGameOver) return;
            const input = document.getElementById('word-input');
            const word = input.value.trim().toLowerCase();
            if (!word) return;

            const cleanInput = word.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            const stemInput = getStem(cleanInput);

            if (gameState.revealedWords.has(cleanInput) || gameState.revealedWords.has(stemInput)) {
                showToast("Already revealed.");
                input.value = '';
                return;
            }
            if (gameState.wrongGuesses.has(cleanInput)) {
                showToast("Already guessed.");
                input.value = '';
                return;
            }

            // Check snippet for word or related stems
            const rawSnippet = gameState.currentScript.snippet.toLowerCase();
            const wordsInSnippet = rawSnippet.split(/[\s,.;:!?()"-]+/).filter(w => w !== "");
            
            let foundCount = 0;
            wordsInSnippet.forEach(w => {
                if (w === cleanInput || getStem(w) === stemInput || getStem(w) === cleanInput || getStem(cleanInput) === w) {
                    foundCount++;
                }
            });

            if (foundCount > 0) {
                showToast(`Hit! Found ${foundCount} instance(s).`);
                gameState.revealedWords.add(cleanInput);
                gameState.revealedWords.add(stemInput);
                renderScript();
            } else {
                showToast(`Miss. "${word}" not found.`);
                gameState.wrongGuesses.add(cleanInput);
                updateScore(-0.5);
            }
            input.value = '';
        }

        function getHint() {
            const rawSnippet = gameState.currentScript.snippet.toLowerCase();
            const wordsInSnippet = rawSnippet.split(/[\s,.;:!?()"-]+/).filter(w => w !== "");
            
            // Map frequencies
            const freqMap = {};
            wordsInSnippet.forEach(w => {
                if (gameState.commonWords.has(w)) return;
                freqMap[w] = (freqMap[w] || 0) + 1;
            });

            // Filter unrevealed
            const unrevealed = Object.keys(freqMap).filter(w => !gameState.revealedWords.has(w) && !gameState.revealedWords.has(getStem(w)));

            if (unrevealed.length === 0) {
                showToast("No hints left!");
                return;
            }

            // Sort by fewiest occurrences, then longest length
            unrevealed.sort((a, b) => {
                if (freqMap[a] !== freqMap[b]) return freqMap[a] - freqMap[b];
                return b.length - a.length;
            });

            const hintWord = unrevealed[0];
            gameState.revealedWords.add(hintWord);
            gameState.revealedWords.add(getStem(hintWord));
            updateScore(-5.0);
            renderScript();
            showToast(`Hint: Revealed "${hintWord}"`);
        }

        function submitGuess() {
            if (gameState.isGameOver) return;
            const input = document.getElementById('guess-input');
            const val = input.value.trim().toLowerCase();
            if (!val) return;

            if (val === gameState.currentScript.title.toLowerCase()) {
                gameState.isGameOver = true;
                showToast("SCENE! Correct Title.");
                renderScript();
            } else {
                updateScore(-2.5);
                showToast("Incorrect Title.");
            }
            input.value = '';
        }

        function giveUp() {
            if (gameState.isGameOver) return;
            gameState.isGameOver = true;
            gameState.score = 0;
            document.getElementById('score-display').innerText = `Score: 0.0`;
            renderScript();
        }

        function openModal() {
            const container = document.getElementById('game-list-container');
            container.innerHTML = '';
            const diffDays = Math.floor(Math.abs(new Date() - EPOCH) / (1000 * 60 * 60 * 24)) + 1;
            for (let i = 1; i <= diffDays; i++) {
                const a = document.createElement('a');
                a.className = 'game-link';
                a.href = `?g=${i}`;
                a.innerText = `#${i}`;
                container.appendChild(a);
            }
            document.getElementById('calendar-modal').style.display = 'block';
        }

        function closeModal() { document.getElementById('calendar-modal').style.display = 'none'; }
        window.onclick = (e) => { if (e.target == document.getElementById('calendar-modal')) closeModal(); }
        window.onload = init;
    </script>
</body>
</html>